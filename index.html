<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Apuestas</title>
    <script
      language="javascript"
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
    ></script>
    <script
      language="javascript"
      type="text/javascript"
      src="web3.min.js"
    ></script>
    <!--<script language="javascript" type="text/javascript" src="cryptozombies_abi.js"></script>-->
  </head>
  <style>
    input {
      display: block;
      margin-bottom: 12px;
    }
  </style>
  <body>
    <h1>Apuestas</h1>
    <p>
      Tenés
      <strong class="balance">aca mostrar la cantidad de tokens</strong>
      Betcoins para apostar!
    </p>

    <h1>Crear Nueva Apuesta</h1>
    <label for="betName">Nombre Apuesta:</label>
    <input type="text" id="betName" placeholder="Ejemplo: Clásico Uruguay" />

    <label for="optionA">Opcion A:</label>
    <input type="text" id="optionA" placeholder="Ejemplo: Gana Peñarol" />

    <label for="optionB">Opcion B:</label>
    <input type="text" id="optionB" placeholder="Ejemplo: Gana Nacional" />

    <label for="oracleAddress">Dirección Oráculo:</label>
    <input
      type="text"
      id="oracleAddress"
      placeholder="Ejemplo 0x93e66d9baea28c17d9fc393b53e3fbdd76899dae"
    />
    <button onclick="createBet()">Crear Apuesta</button>
    <div id="status"></div>
    <div id="activeBetsContainer"></div>

    <script>
      var activeBets
      var userAccount
      var betFactory

      function startApp() {
        // var contractAddress = '0x0670aC3F427d8D0ba60BE604280B931340ff97ba'
        import betFactoryArtifact from '../../build/contracts/BetFactory.json'
        const networkId = await web3.eth.net.getId()
        const deployedNetwork = betFactoryArtifact.networks[networkId]
        this.betFactory = new web3.eth.Contract(
        betFactoryArtifact.abi,
        deployedNetwork.address
        )

        var accountInterval = setInterval(function () {
          if (web3.eth.accounts[0] !== userAccount) {
            userAccount = web3.eth.accounts[0]
            activeBets = betFactory._getBets();
            displayBets(activeBets)
          }
        }, 100)
      }

      async function createBet() {
        const betName = document.getElementById('betName').value
        const optionA = document.getElementById('optionA').value
        const optionB = document.getElementById('optionB').value
        const oracleAddress = document.getElementById('oracleAddress').value
        this.setStatus('Creando Apuesta... (Por favor espere)')
        const { _createBet } = this.betFactoryArtifact.methods
        await createBet(oracleAddress, betName, optionA, optionB).send({
        from: this.userAccount
        })
        this.setStatus('Transacción completa!')
        // this.getBets() Puede no ser necesario si el account interval refresca la informacion
        // this.refreshBalance() Hay que mostrar el saldo de la cuenta actualizado
      }

      function setStatus(message) {
        const status = document.getElementById('status')
        status.innerHTML = message
      }

      function displayBets(bets) {
        $('#activeBetsContainer').empty()
        for (bet of bets) {
          $('#activeBetsContainer').append(`<div class="bet">
            <ul>
              <li>Name: ${bet.getName()}</li>
              <li>Opción A: ${bet.getOptionA()}</li>
              <li>Opción B: ${bet.getOptionA()}</li>
            </ul>
          </div>`)
        }
      }

      window.addEventListener('load', function () {
        if (typeof web3 !== 'undefined') {
          web3js = new Web3(web3.currentProvider)
        } else {
          alert('Instale Metamask para continuar');
        }

        startApp()
      })
    </script>
  </body>
</html>

<!--<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Webpack App</title>
    </head>
    <body>
        <h1>Hello world!</h1>
        <h2>Tip: Check your console</h2>
    </body>
    
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker
                    .register("service-worker.js")
                    .then((registration) => {
                        console.log("Service Worker registered: ", registration);
                    })
                    .catch((registrationError) => {
                        console.error("Service Worker registration failed: ", registrationError);
                    });
            });
        }
    </script>
</html>-->
